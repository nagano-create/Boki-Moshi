<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—¥å•†ç°¿è¨˜3ç´š ç¬¬1å•ï¼ˆä»•è¨³ï¼‰Aã‚»ãƒƒãƒˆ - ã‚¿ãƒƒãƒãƒ¢ãƒ¼ãƒ‰</title>
  <style>
    :root{
      --bd:#ddd; --mut:#666; --ok:#1a7f37; --ng:#b42318;
      --bg:#fafafa; --card:#fff; --shadow: 0 8px 18px rgba(0,0,0,.06);
    }
    body{font-family:system-ui,-apple-system,"Segoe UI","Hiragino Kaku Gothic ProN","Meiryo",sans-serif; margin:18px; background:var(--bg);}
    .wrap{max-width:1100px; margin:0 auto;}
    h1{font-size:20px; margin:0 0 6px;}
    .sub{color:var(--mut); margin-bottom:14px; font-size:13px; line-height:1.5;}
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
      margin:10px 0 14px;
    }
    .pill{border:1px solid var(--bd); background:#fff; padding:6px 10px; border-radius:999px; font-size:13px;}
    button{
      padding:10px 14px; border:1px solid #999; background:#fff; border-radius:10px;
      cursor:pointer; font-size:14px; box-shadow: none;
    }
    button:hover{background:#f5f5f5;}
    button:disabled{opacity:.5; cursor:not-allowed;}
    .card{
      background:var(--card); border:1px solid var(--bd); border-radius:16px;
      padding:14px; box-shadow: var(--shadow);
    }
    .qhead{display:flex; justify-content:space-between; align-items:flex-start; gap:10px;}
    .qid{font-weight:900; font-size:18px;}
    .diff{font-size:12px; color:#111; border:1px solid var(--bd); padding:2px 8px; border-radius:999px; background:#fff;}
    .qtext{margin:10px 0 14px; font-size:16px; line-height:1.6;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .side{
      border:1px dashed var(--bd); border-radius:14px; padding:12px;
      background:#fff;
    }
    .side h3{margin:0 0 10px; font-size:14px;}
    .slots{display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:10px;}
    .slot{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border:1px solid var(--bd); border-radius:12px; padding:10px;
      min-height:44px;
      background:#fff;
    }
    .slot .ph{color:#aaa;}
    .xbtn{
      border:1px solid var(--bd); border-radius:10px; padding:6px 10px; background:#fff; cursor:pointer;
      font-size:13px;
    }
    .xbtn:hover{background:#f7f7f7;}
    .bank{display:flex; flex-wrap:wrap; gap:8px;}
    .accbtn{
      border:1px solid var(--bd);
      border-radius:999px; padding:10px 12px;
      background:#fff; cursor:pointer;
      font-size:14px;
      user-select:none;
      touch-action:manipulation;
    }
    .accbtn:hover{background:#f5f5f5;}
    .accbtn.on{
      border-color:#333;
      background:#f0f0f0;
      font-weight:700;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:14px;}
    .status{font-weight:800;}
    .ok{color:var(--ok);}
    .ng{color:var(--ng);}
    details{margin-top:10px;}
    summary{cursor:pointer; font-weight:800;}
    .exp{margin-top:8px; line-height:1.7;}
    .mut{color:var(--mut); font-size:13px;}

    /* flower (perfect) */
    .overlay{
      position:fixed; inset:0;
      display:none; align-items:center; justify-content:center;
      background:rgba(0,0,0,.25);
      z-index:9999;
    }
    .overlay.show{display:flex;}
    .modal{
      background:#fff; border-radius:18px; padding:18px 18px 12px;
      border:1px solid var(--bd); width:min(520px, 92vw);
      box-shadow: 0 16px 40px rgba(0,0,0,.20);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .modal h2{margin:4px 0 6px; font-size:22px;}
    .modal .mut{margin-bottom:10px;}
    .petal{
      position:absolute;
      width:14px; height:10px;
      border-radius: 14px 14px 14px 0;
      transform: rotate(25deg);
      opacity:.95;
      animation: fall 1.8s linear forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-40px) rotate(0deg); opacity:0; }
      10%{opacity:1;}
      100%{ transform: translateY(420px) rotate(360deg); opacity:0; }
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>æ—¥å•†ç°¿è¨˜3ç´š ç¬¬1å•ï¼ˆä»•è¨³ï¼‰Aã‚»ãƒƒãƒˆï¼ˆ15å•ï¼‰ - ã‚¿ãƒƒãƒãƒ¢ãƒ¼ãƒ‰</h1>
  <div class="sub">
    ç›®çš„ï¼š<b>åˆ¤æ–­ã‚¹ãƒ”ãƒ¼ãƒ‰</b>ã€‚é‡‘é¡å…¥åŠ›ãªã—ã€‚å·¦å³ã®å‹˜å®šç§‘ç›®ã‚’ã‚¿ãƒƒãƒ—ã§é¸ã³ã€<b>æ¡ç‚¹â†’æ¬¡ã¸</b>ã‚’ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚<br/>
    æº€ç‚¹ï¼ˆ15/15ï¼‰ã ã‘ã€æœ€å¾Œã«ã€ŒèŠ±ã€ãŒå‡ºã¾ã™ã€‚
  </div>

  <div class="topbar">
    <div class="pill">é€²æ—ï¼š<span id="prog">1</span> / 15</div>
    <div class="pill">å¾—ç‚¹ï¼š<span id="score">0</span> / 15</div>
    <div class="pill">é›£æ˜“åº¦ï¼š<span id="diff">-</span></div>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button id="resetQ">ã“ã®å•é¡Œã‚’ã‚¯ãƒªã‚¢</button>
      <button id="restart">æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™</button>
    </div>
  </div>

  <div class="card">
    <div class="qhead">
      <div class="qid">ã€<span id="qid">1</span>ã€‘<span class="mut"> <span id="diffInline"></span></span></div>
      <div class="diff" id="diffBadge">-</div>
    </div>

    <div class="qtext" id="qtext">ï¼ˆå•é¡Œæ–‡ï¼‰</div>

    <div class="grid">
      <div class="side">
        <h3>å€Ÿæ–¹ï¼ˆå·¦ï¼‰</h3>
        <div class="slots" id="debitSlots"></div>
        <div class="bank" id="debitBank"></div>
      </div>

      <div class="side">
        <h3>è²¸æ–¹ï¼ˆå³ï¼‰</h3>
        <div class="slots" id="creditSlots"></div>
        <div class="bank" id="creditBank"></div>
      </div>
    </div>

    <div class="actions">
      <button id="grade">æ¡ç‚¹</button>
      <button id="next" disabled>æ¬¡ã¸</button>
      <span class="status" id="status"></span>
    </div>

    <details id="details" style="display:none;">
      <summary>è§£ç­”ãƒ»è§£èª¬ã‚’è¦‹ã‚‹</summary>
      <div class="exp" id="exp"></div>
      <div class="mut" id="ansHint"></div>
    </details>
  </div>
</div>

<!-- Perfect overlay -->
<div class="overlay" id="overlay">
  <div class="modal" id="modal">
    <h2>Perfect! ğŸŒ¸</h2>
    <div class="mut">15/15 æ­£è§£ã§ã™ã€‚ã™ã”ã„ï¼</div>
    <button id="closeOverlay">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
/** =========================
 * Aã‚»ãƒƒãƒˆï¼ˆã‚¿ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
 *  - æ¡ç‚¹ã¯ã€Œå‹˜å®šç§‘ç›®ã®ã¿ã€ã§åˆ¤å®šï¼ˆè¡Œé †ä¸å•ï¼‰
 *  - å„å• choices: 6å€‹ï¼ˆå·¦å³å…±é€šï¼‰
 * ========================= **/
const SET_A = [
  {id:1, diff:"æ˜“", q:"ç¾é‡‘40,000å††ã§å•†å“ã‚’ä»•å…¥ã‚ŒãŸã€‚",
   choices:["ç¾é‡‘","ä»•å…¥","å•†å“","å£²ä¸Š","è²·æ›é‡‘","æœªæ‰•é‡‘"],
   ans:{debit:[["ä»•å…¥",40000]], credit:[["ç¾é‡‘",40000]]},
   exp:"å•†å“ã‚’ä»•å…¥ã‚ŒãŸã®ã§å·¦ã¯ä»•å…¥ã€‚ç¾ã«é‡‘ãŒã‚ã‚‹ã®ã§å³ã¯ç¾é‡‘ã€‚"
  },
  {id:2, diff:"æ˜“", q:"å•†å“50,000å††ã‚’æ›ã‘ã§è²©å£²ã—ãŸã€‚",
   choices:["å£²ä¸Š","ç¾é‡‘","å£²æ›é‡‘","ä»•å…¥","å‰å—é‡‘","è²·æ›é‡‘"],
   ans:{debit:[["å£²æ›é‡‘",50000]], credit:[["å£²ä¸Š",50000]]},
   exp:"ç¾ã«é‡‘ãŒãªã„â†’å£²æ›é‡‘ã€‚ç¨¼ã„ã è¨˜éŒ²ã¯å£²ä¸Šï¼ˆå³ï¼‰ã€‚"
  },
  {id:3, diff:"æ˜“", q:"ç¾é‡‘30,000å††ã‚’å€Ÿã‚Šå…¥ã‚ŒãŸã€‚",
   choices:["ç¾é‡‘","å€Ÿå…¥é‡‘","å…ƒå…¥é‡‘","å—å–åˆ©æ¯","æ”¯æ‰•åˆ©æ¯","é›‘åå…¥"],
   ans:{debit:[["ç¾é‡‘",30000]], credit:[["å€Ÿå…¥é‡‘",30000]]},
   exp:"ç¾é‡‘ãŒå¢—ãˆãŸã€‚å€Ÿé‡‘ã‚‚å¢—ãˆãŸã®ã§å³ã¯å€Ÿå…¥é‡‘ã€‚"
  },
  {id:4, diff:"æ˜“", q:"äº‹å‹™ç”¨å“10,000å††ã‚’å¾Œæ‰•ã„ã§è³¼å…¥ã—ãŸã€‚",
   choices:["æ¶ˆè€—å“è²»","ç¾é‡‘","æœªæ‰•é‡‘","è²·æ›é‡‘","å‚™å“","é›‘è²»"],
   ans:{debit:[["æ¶ˆè€—å“è²»",10000]], credit:[["æœªæ‰•é‡‘",10000]]},
   exp:"äº‹å‹™ç”¨å“ã¯è²»ç”¨ã€‚ç¾ã«é‡‘ãŒãªã„â†’æœªæ‰•é‡‘ã€‚"
  },
  {id:5, diff:"æ˜“", q:"å£²æ›é‡‘20,000å††ã‚’ç¾é‡‘ã§å›åã—ãŸã€‚",
   choices:["ç¾é‡‘","å£²æ›é‡‘","å£²ä¸Š","é›‘åå…¥","å‰å—é‡‘","æœªåé‡‘"],
   ans:{debit:[["ç¾é‡‘",20000]], credit:[["å£²æ›é‡‘",20000]]},
   exp:"å¾Œã§ã‚‚ã‚‰ã†ç¾é‡‘ï¼ˆå£²æ›é‡‘ï¼‰ãŒã€ç¾é‡‘ã«ãªã£ãŸã ã‘ã€‚"
  },

  {id:6, diff:"ä¸­", q:"å•†å“80,000å††ã‚’ä»•å…¥ã‚Œã€ä»£é‡‘ã®ã†ã¡50,000å††ã‚’ç¾é‡‘ã§æ”¯æ‰•ã„ã€æ®‹ã‚Šã¯æ›ã‘ã¨ã—ãŸã€‚",
   choices:["ä»•å…¥","ç¾é‡‘","è²·æ›é‡‘","æœªæ‰•é‡‘","å•†å“","å‰æ‰•é‡‘"],
   ans:{debit:[["ä»•å…¥",80000]], credit:[["ç¾é‡‘",50000],["è²·æ›é‡‘",30000]]},
   exp:"å•†å“ãªã®ã§ä»•å…¥ã€‚ç¾ã«é‡‘ãŒãªã„åˆ†ã¯æ›ï¼ˆè²·æ›é‡‘ï¼‰ã€‚"
  },
  {id:7, diff:"ä¸­", q:"å®¶è³ƒ12,000å††ã‚’å¾Œæ‰•ã„ã¨ã—ãŸã€‚",
   choices:["æ”¯æ‰•å®¶è³ƒ","æœªæ‰•é‡‘","ç¾é‡‘","å‰æ‰•è²»ç”¨","é›‘è²»","è²·æ›é‡‘"],
   ans:{debit:[["æ”¯æ‰•å®¶è³ƒ",12000]], credit:[["æœªæ‰•é‡‘",12000]]},
   exp:"å®¶è³ƒã¯è²»ç”¨ã€‚ç¾ã«é‡‘ãŒãªã„â†’æœªæ‰•é‡‘ã€‚"
  },
  {id:8, diff:"ä¸­", q:"ç¾é‡‘éä¸è¶³ãŒ5,000å††ã®ä¸è¶³ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã€‚",
   choices:["ç¾é‡‘","ç¾é‡‘éä¸è¶³","é›‘æ","é›‘åå…¥","å£²ä¸Š","ä»•å…¥"],
   ans:{debit:[["ç¾é‡‘éä¸è¶³",5000]], credit:[["ç¾é‡‘",5000]]},
   exp:"ç¾é‡‘ãŒè¶³ã‚Šãªã„â†’ç¾é‡‘ã¯å³ã€‚åŸå› ä¸æ˜ã®ç®±ï¼ç¾é‡‘éä¸è¶³ã€‚"
  },
  {id:9, diff:"ä¸­", q:"å€Ÿå…¥é‡‘30,000å††ã‚’ç¾é‡‘ã§è¿”æ¸ˆã—ãŸã€‚",
   choices:["å€Ÿå…¥é‡‘","ç¾é‡‘","æ”¯æ‰•åˆ©æ¯","å…ƒå…¥é‡‘","é›‘è²»","æœªæ‰•é‡‘"],
   ans:{debit:[["å€Ÿå…¥é‡‘",30000]], credit:[["ç¾é‡‘",30000]]},
   exp:"å€Ÿé‡‘ã‚’æ¸›ã‚‰ã—ãŸã®ã§å·¦ã¯å€Ÿå…¥é‡‘ã€‚ç¾é‡‘ã¯å‡ºã¦ã„ãã€‚"
  },
  {id:10, diff:"ä¸­", q:"å•†å“30,000å††ã‚’è²©å£²ã—ã€ä»£é‡‘ã¯å¾Œæ—¥å—ã‘å–ã‚‹ã“ã¨ã¨ã—ãŸã€‚",
   choices:["å£²æ›é‡‘","å£²ä¸Š","ç¾é‡‘","æœªåé‡‘","å‰å—é‡‘","ä»•å…¥"],
   ans:{debit:[["å£²æ›é‡‘",30000]], credit:[["å£²ä¸Š",30000]]},
   exp:"è²©å£²ã—ãŸã‚‰å£²ä¸Šã€‚ç¾ã«é‡‘ãŒãªã„â†’å£²æ›é‡‘ã€‚"
  },

  {id:11, diff:"é›£", q:"å£²æ›é‡‘15,000å††ãŒå›åä¸èƒ½ã¨ãªã£ãŸã€‚",
   choices:["è²¸å€’æå¤±","å£²æ›é‡‘","ç¾é‡‘","é›‘æ","å£²ä¸Š","ç¾é‡‘éä¸è¶³"],
   ans:{debit:[["è²¸å€’æå¤±",15000]], credit:[["å£²æ›é‡‘",15000]]},
   exp:"å–ã‚Œãªã„ãŠé‡‘ã¯æã€‚æã¯å·¦ã€‚å£²æ›é‡‘ï¼ˆè³‡ç”£ï¼‰ã‚’æ¶ˆã™ã®ã§å³ã€‚"
  },
  {id:12, diff:"é›£", q:"å‚™å“40,000å††ã‚’è³¼å…¥ã—ã€ä»£é‡‘ã®ã†ã¡20,000å††ã‚’ç¾é‡‘ã§æ”¯æ‰•ã„ã€æ®‹ã‚Šã¯å¾Œæ‰•ã„ã¨ã—ãŸã€‚",
   choices:["å‚™å“","ç¾é‡‘","æœªæ‰•é‡‘","è²·æ›é‡‘","æ¶ˆè€—å“è²»","é›‘è²»"],
   ans:{debit:[["å‚™å“",40000]], credit:[["ç¾é‡‘",20000],["æœªæ‰•é‡‘",20000]]},
   exp:"å‚™å“ã¯è³‡ç”£ï¼ˆå·¦ï¼‰ã€‚å¾Œæ‰•ã„ã¯æœªæ‰•é‡‘ï¼ˆâ€»è²·æ›é‡‘ã§ã¯ãªã„ï¼‰ã€‚"
  },
  {id:13, diff:"é›£", q:"ç¾é‡‘éä¸è¶³5,000å††ã«ã¤ã„ã¦ã€åŸå› ãŒé›‘åå…¥ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜ã—ãŸã€‚",
   choices:["ç¾é‡‘éä¸è¶³","é›‘åå…¥","ç¾é‡‘","é›‘æ","å£²ä¸Š","ä»•å…¥"],
   ans:{debit:[["ç¾é‡‘éä¸è¶³",5000]], credit:[["é›‘åå…¥",5000]]},
   exp:"åŸå› ãŒç›Šï¼ˆé›‘åå…¥ï¼‰ã¨åˆ¤æ˜â†’ç›Šã¯å³ã€‚ç¾é‡‘éä¸è¶³ï¼ˆå·¦ï¼‰ã‚’æ¶ˆã™ã€‚"
  },
  {id:14, diff:"é›£", q:"å—å–æ‰‹å½¢20,000å††ã‚’ç¾é‡‘ã§å›åã—ãŸã€‚",
   choices:["ç¾é‡‘","å—å–æ‰‹å½¢","å£²æ›é‡‘","å£²ä¸Š","é›‘åå…¥","æœªåé‡‘"],
   ans:{debit:[["ç¾é‡‘",20000]], credit:[["å—å–æ‰‹å½¢",20000]]},
   exp:"å—å–æ‰‹å½¢ï¼ˆå¾Œã§ã‚‚ã‚‰ã†ç¾é‡‘ï¼‰ãŒç¾é‡‘ã«ãªã£ãŸã€‚"
  },
  {id:15, diff:"é›£", q:"åºƒå‘Šè²»18,000å††ã‚’ç¾é‡‘ã§æ”¯æ‰•ã£ãŸã€‚",
   choices:["åºƒå‘Šå®£ä¼è²»","ç¾é‡‘","æœªæ‰•é‡‘","å‰æ‰•è²»ç”¨","é›‘è²»","ä»•å…¥"],
   ans:{debit:[["åºƒå‘Šå®£ä¼è²»",18000]], credit:[["ç¾é‡‘",18000]]},
   exp:"ã‚µãƒ¼ãƒ“ã‚¹ã¯ä»•å…¥ã«ãªã‚‰ãªã„ã€‚è²»ç”¨ã¯å·¦ã€‚"
  }
];

/** ---------- ã‚¿ãƒƒãƒåˆ¤å®šï¼šå‹˜å®šç§‘ç›®ã®ã¿ï¼ˆè¡Œé †ä¸å•ãƒ»é‡è¤‡å¯¾å¿œï¼‰ ---------- **/
const multisetEqual = (a, b) => {
  if (a.length !== b.length) return false;
  const m = new Map();
  for (const x of a) m.set(x, (m.get(x)||0)+1);
  for (const x of b) {
    const v = m.get(x)||0;
    if (v === 0) return false;
    if (v === 1) m.delete(x); else m.set(x, v-1);
  }
  return m.size === 0;
};
const ansAccounts = (q) => ({
  debit: q.ans.debit.map(([a,_]) => a),
  credit: q.ans.credit.map(([a,_]) => a)
});
const fmtAns = (q) => {
  const d = q.ans.debit.map(([a,amt])=> `${a} ${amt.toLocaleString()}`).join(" / ");
  const c = q.ans.credit.map(([a,amt])=> `${a} ${amt.toLocaleString()}`).join(" / ");
  return `æ­£ç­”ï¼ˆå‚è€ƒï¼‰ï¼šå€Ÿæ–¹ ${d} ï½œ è²¸æ–¹ ${c}`;
};

/** ---------- çŠ¶æ…‹ ---------- **/
let idx = 0;
let score = 0;
let graded = Array(SET_A.length).fill(false);
let correct = Array(SET_A.length).fill(false);

// é¸æŠï¼ˆæœ€å¤§3ï¼‰
let selD = [];
let selC = [];

/** ---------- UI refs ---------- **/
const qid = document.getElementById("qid");
const qtext = document.getElementById("qtext");
const prog = document.getElementById("prog");
const scoreEl = document.getElementById("score");
const diff = document.getElementById("diff");
const diffBadge = document.getElementById("diffBadge");
const diffInline = document.getElementById("diffInline");

const debitSlots = document.getElementById("debitSlots");
const creditSlots = document.getElementById("creditSlots");
const debitBank = document.getElementById("debitBank");
const creditBank = document.getElementById("creditBank");

const statusEl = document.getElementById("status");
const gradeBtn = document.getElementById("grade");
const nextBtn = document.getElementById("next");
const resetQBtn = document.getElementById("resetQ");
const restartBtn = document.getElementById("restart");

const details = document.getElementById("details");
const expEl = document.getElementById("exp");
const ansHint = document.getElementById("ansHint");

/** ---------- overlay ---------- **/
const overlay = document.getElementById("overlay");
const modal = document.getElementById("modal");
document.getElementById("closeOverlay").addEventListener("click", () => {
  overlay.classList.remove("show");
  // petals cleanup
  modal.querySelectorAll(".petal").forEach(p => p.remove());
});

/** ---------- render helpers ---------- **/
function renderSlots(){
  const makeSlots = (arr, side) => {
    const host = side === "D" ? debitSlots : creditSlots;
    host.innerHTML = "";
    for (let i=0;i<3;i++){
      const v = arr[i] || "";
      const div = document.createElement("div");
      div.className = "slot";
      const left = document.createElement("div");
      left.innerHTML = v ? `<b>${v}</b>` : `<span class="ph">ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰</span>`;
      const right = document.createElement("button");
      right.className = "xbtn";
      right.textContent = v ? "å–æ¶ˆ" : "â€”";
      right.disabled = !v;
      right.addEventListener("click", () => {
        if (!v) return;
        arr.splice(i,1);
        renderSlots();
        renderBanks();
        resetStatusOnly();
      });
      div.appendChild(left);
      div.appendChild(right);
      host.appendChild(div);
    }
  };
  makeSlots(selD, "D");
  makeSlots(selC, "C");
}

function renderBanks(){
  const q = SET_A[idx];
  const makeBtn = (acc, side) => {
    const b = document.createElement("button");
    b.className = "accbtn";
    b.textContent = acc;

    const arr = side === "D" ? selD : selC;
    const on = arr.includes(acc);
    if (on) b.classList.add("on");

    b.addEventListener("click", () => {
      // if already selected -> remove
      const pos = arr.indexOf(acc);
      if (pos >= 0){
        arr.splice(pos,1);
        renderSlots(); renderBanks(); resetStatusOnly();
        return;
      }
      // add if space
      if (arr.length >= 3) return;
      arr.push(acc);
      renderSlots(); renderBanks(); resetStatusOnly();
    });
    return b;
  };

  debitBank.innerHTML = "";
  creditBank.innerHTML = "";
  q.choices.forEach(acc => {
    debitBank.appendChild(makeBtn(acc, "D"));
    creditBank.appendChild(makeBtn(acc, "C"));
  });
}

function resetStatusOnly(){
  statusEl.textContent = "";
  statusEl.className = "status";
  details.style.display = "none";
  nextBtn.disabled = true;
}

function renderQuestion(){
  const q = SET_A[idx];
  qid.textContent = q.id;
  qtext.textContent = q.q;

  prog.textContent = (idx+1);
  scoreEl.textContent = score;
  diff.textContent = q.diff;
  diffBadge.textContent = q.diff;
  diffInline.textContent = q.diff;

  selD = [];
  selC = [];
  renderSlots();
  renderBanks();

  // already graded?
  statusEl.textContent = "";
  statusEl.className = "status";
  if (graded[idx]){
    statusEl.textContent = correct[idx] ? "æ­£è§£ï¼ˆæ¡ç‚¹æ¸ˆï¼‰" : "ä¸æ­£è§£ï¼ˆæ¡ç‚¹æ¸ˆï¼‰";
    statusEl.classList.add(correct[idx] ? "ok":"ng");
    nextBtn.disabled = false;
    // show explanation (å­¦ç¿’ç”¨ã¨ã—ã¦ã¯è¦‹ã›ã¦OK)
    details.style.display = "block";
    expEl.textContent = q.exp;
    ansHint.textContent = fmtAns(q);
  } else {
    details.style.display = "none";
    nextBtn.disabled = true;
  }
}

function gradeCurrent(){
  const q = SET_A[idx];
  const ans = ansAccounts(q);

  // æœªé¸æŠãŒæ®‹ã£ã¦ãŸã‚‰æ¡ç‚¹ä¸å¯ã«ã™ã‚‹ï¼ˆä½“é¨“ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ï¼‰
  // â€»ç­”ãˆãŒ2è¡Œã®ã¨ãã‚‚ã‚ã‚‹ã®ã§ã€Œé¸ã³ã™ãã€ã¯ä¸æ­£è§£ã«å«ã‚ã‚‹
  const ok = multisetEqual(selD, ans.debit) && multisetEqual(selC, ans.credit);

  if (!graded[idx]){
    graded[idx] = true;
    correct[idx] = ok;
    if (ok) score++;
  }

  statusEl.textContent = ok ? "æ­£è§£" : "ä¸æ­£è§£";
  statusEl.className = "status " + (ok ? "ok":"ng");
  scoreEl.textContent = score;

  // è§£èª¬è¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒã§ã‚‚è¦‹ã›ã‚‹ï¼šå…ˆç”Ÿã®æ–¹é‡ï¼‰
  details.style.display = "block";
  expEl.textContent = q.exp;
  ansHint.textContent = fmtAns(q);

  nextBtn.disabled = false;

  // æœ€å¾Œã®å•é¡Œã§ã€å…¨å•æ¡ç‚¹æ¸ˆã¿ãªã‚‰Perfectåˆ¤å®š
  if (idx === SET_A.length - 1){
    const allDone = graded.every(Boolean);
    if (allDone && score === 15){
      showPerfect();
    }
  }
}

function showPerfect(){
  overlay.classList.add("show");
  // petals
  for (let i=0;i<42;i++){
    const p = document.createElement("div");
    p.className = "petal";
    p.style.left = (Math.random()*100) + "%";
    p.style.top = (-30 - Math.random()*120) + "px";
    p.style.animationDelay = (Math.random()*0.25) + "s";
    p.style.transform = `rotate(${Math.random()*360}deg)`;
    // no hard-coded colors? -> use default; still need a color, but minimal:
    // using varied opacity with neutral pink-ish is okay for effect; if you prefer, I can remove variation.
    p.style.background = `rgba(255, 182, 193, ${0.75 + Math.random()*0.2})`;
    modal.appendChild(p);
    setTimeout(()=>p.remove(), 2200);
  }
}

/** ---------- events ---------- **/
gradeBtn.addEventListener("click", gradeCurrent);

nextBtn.addEventListener("click", () => {
  if (idx < SET_A.length - 1){
    idx++;
    renderQuestion();
  } else {
    // end
    if (score === 15) showPerfect();
    else alert(`çµ‚äº†ï¼š${score}/15ï¼ˆæº€ç‚¹ã§ã‚‚ã†ä¸€åº¦ï¼ï¼‰`);
  }
});

resetQBtn.addEventListener("click", () => {
  // ãã®å•é¡Œã®é¸æŠã ã‘ã‚¯ãƒªã‚¢ï¼ˆæ¡ç‚¹å‰æï¼‰
  selD = [];
  selC = [];
  renderSlots(); renderBanks(); resetStatusOnly();
});

restartBtn.addEventListener("click", () => {
  idx = 0;
  score = 0;
  graded = Array(SET_A.length).fill(false);
  correct = Array(SET_A.length).fill(false);
  renderQuestion();
});

renderQuestion();
</script>
</body>
</html>
